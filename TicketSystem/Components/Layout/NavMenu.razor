@using Microsoft.AspNetCore.Identity
@using TicketSystem.Data
@using TicketSystem.Services
@implements IDisposable
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject PermissionService PermissionService
@inject SignInManager<ApplicationUser> SignInManager
@inject IHttpContextAccessor _httpContextAccessor
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<button dir="rtl" class="btn btn-light d-md-none position-fixed hamburger-menu top-0 end-0 m-2 z-3"
        @onclick="ToggleSidebar">
    <i class="bi bi-list fs-3"></i>
</button>

<div class="@sidebarClass sidebar"
     style="height: 100vh; width: 250px; font-size: 1.1rem; overflow: hidden; transition: all 0.3s;"
     dir="rtl">

    <div class="navbar px-3 py-2 border-bottom border-secondary fs-5 bg-light shadow-sm">
        <img src="images/logo/Logo.png" alt="Logo" style="height: 40px;" />
        <a class="navbar-brand fw-bold text-dark text-uppercase ms-2" href="/">TicketBox</a>
    </div>

    <div class="flex-grow-1 overflow-auto px-2 pt-3 bg-white" style="padding-bottom: 1rem;">
        <nav class="nav flex-column text-dark">
            <div class="nav flex-column">

                <div class="nav-item mb-2">
                    <NavLink class="nav-link text-dark d-flex align-items-center" href="/" Match="NavLinkMatch.All" ActiveClass="active">
                        <i class="bi bi-house-heart-fill me-3 icon-hover"></i> الرئيسية
                    </NavLink>
                </div>

                @if (canViewOrderFixed)
                {
                    <div class="nav-item mb-2">
                        <NavLink class="nav-link text-dark d-flex align-items-center" href="orderfixed" ActiveClass="active">
                            <i class="bi bi-hammer me-3 icon-hover"></i> الخدمات
                        </NavLink>
                    </div>
                }

                @if (canViewOrders)
                {
                    <div class="nav-item mb-2">
                        <NavLink class="nav-link text-dark d-flex align-items-center" href="order" ActiveClass="active">
                            <i class="bi bi-journal-check me-3 icon-hover"></i> طلبات الأقسام
                        </NavLink>
                    </div>
                }

                <AuthorizeView>
                    <Authorized>
                        <div class="nav-item mb-2">
                            <NavLink class="nav-link text-dark d-flex align-items-center" href="order-list" ActiveClass="active">
                                <i class="bi bi-person-badge me-3 icon-hover"></i> طلباتي
                            </NavLink>
                        </div>
                    </Authorized>
                </AuthorizeView>

                @if (canViewSections)
                {
                    <div class="nav-item mb-2">
                        <NavLink class="nav-link text-dark d-flex align-items-center" href="sections" ActiveClass="active">
                            <i class="bi bi-diagram-2-fill me-3 icon-hover"></i> إدارة الأقسام
                        </NavLink>
                    </div>
                }

                <AuthorizeView Roles="Admin">
                    <Authorized>
                        <div class="nav-item mb-2">
                            <NavLink class="nav-link text-dark d-flex align-items-center" href="admin/user-roles" ActiveClass="active">
                                <i class="bi bi-key-fill me-3 icon-hover"></i> إضافة الصلاحيات
                            </NavLink>
                        </div>
                    </Authorized>
                </AuthorizeView>

                <AuthorizeView>
                    <Authorized>
                        @if (isAdmin || canManageUsers)
                        {
                            <div class="nav-item mb-2">
                                <NavLink class="nav-link text-dark d-flex align-items-center" href="users" ActiveClass="active">
                                    <i class="bi bi-people-fill me-3 icon-hover"></i> إدارة المستخدمين
                                </NavLink>
                            </div>
                        }
                    </Authorized>
                </AuthorizeView>

                @if (canViewRates)
                {
                    <div class="nav-item mb-2">
                        <NavLink class="nav-link text-dark d-flex align-items-center" href="rates" ActiveClass="active">
                            <i class="bi bi-pie-chart-fill me-3 icon-hover"></i> توزيع النقاط
                        </NavLink>
                    </div>
                }

                @if (canViewPoints)
                {
                    <div class="nav-item mb-2">
                        <NavLink class="nav-link text-dark d-flex align-items-center" href="points-tracking" ActiveClass="active">
                            <i class="bi bi-graph-up-arrow me-3 icon-hover"></i> تقارير النقاط
                        </NavLink>
                    </div>
                }

                @if (canViewFixed)
                {
                    <div class="nav-item mb-2">
                        <NavLink class="nav-link text-dark d-flex align-items-center" href="service-usage" ActiveClass="active">
                            <i class="bi bi-file-earmark-text-fill me-3 icon-hover"></i> تقارير الخدمات
                        </NavLink>
                    </div>
                }

            </div>

            <style>
                /* Hover effect للقائمة */
                .nav-link:hover {
                    background-color: #e9ecef; /* رصاصي فاتح عند المرور */
                    color: #000;
                    transition: background-color 0.2s ease-in-out;
                }

                /* Active page */
                .nav-link.active {
                    background-color: #f8f9fa; /* رصاصي فاتح عند التحديد */
                    color: #000;
                    border-radius: 0.25rem;
                }

                /* أيقونات متحركة عند Hover */
                .icon-hover {
                    transition: transform 0.2s ease-in-out;
                }

                .nav-link:hover .icon-hover {
                    transform: translateX(5px) scale(1.2);
                }
            </style>

        </nav>
    </div>

    <div class="border-top border-secondary p-3 small fs-6 bg-light">
        <AuthorizeView>
            <Authorized>
                <div class="mb-2">
                    <a href="/my-profile" class="text-decoration-none text-dark">
                        مرحبًا، @context.User.Identity?.Name
                    </a>
                </div>
                <button class="btn btn-outline-dark btn-sm w-100"
                        @onclick="@(() => NavigationManager.NavigateTo("/logout", forceLoad: true))">
                    <i class="bi bi-box-arrow-left"></i> تسجيل الخروج
                </button>
            </Authorized>
            <NotAuthorized>
                <NavLink class="btn btn-outline-dark btn-sm w-100 mb-2" href="Account/Login">
                    <i class="bi bi-box-arrow-in-right"></i> تسجيل الدخول
                </NavLink>
                <NavLink class="btn btn-outline-dark btn-sm w-100" href="Account/Register">
                    <i class="bi bi-person-plus"></i> تسجيل حساب
                </NavLink>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</div>

@code {
    private bool isSidebarVisible = false;
    private bool isAdmin;

    private bool canViewOrders;
    private bool canViewOrderFixed;
    private bool canViewSections;
    private bool canViewRates;
    private bool canViewPoints;
    private bool canManageUsers;
    private bool canViewFixed;

    private string sidebarClass =>
        isSidebarVisible
            ? "d-flex flex-column bg-white text-dark no-print position-fixed top-0 end-0 z-2 shadow"
            : "d-none d-md-flex flex-column bg-white text-dark no-print position-fixed top-0 end-0 shadow";

    private void ToggleSidebar() => isSidebarVisible = !isSidebarVisible;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;

        if (userClaims.Identity != null && userClaims.Identity.IsAuthenticated)
        {
            // جلب ApplicationUser من UserManager
            var appUser = await UserManager.GetUserAsync(userClaims);

            if (appUser != null)
            {
                var permissions = await PermissionService.GetUserPermissionsAsync(appUser);

                isAdmin = permissions.Contains("Admin");
                canViewOrders = permissions.Contains("Permissions.orders.View");
                canViewOrderFixed = permissions.Contains("Permissions.orderfixed.View");
                canViewSections = permissions.Contains("Permissions.Sections.View");
                canViewRates = permissions.Contains("Permissions.rates.View");
                canViewPoints = permissions.Contains("Permissions.Points.View");
                canManageUsers = permissions.Contains("Permissions.users.View");
                canViewFixed = permissions.Contains("Permissions.serviceUsage.View");

            }
        }

        NavigationManager.LocationChanged += OnLocationChanged;
        StateHasChanged();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        isSidebarVisible = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}

<style>
    .nav-link.active {
        background-color: #e9ecef;
        font-weight: bold;
        border-radius: 0.375rem;
        color: #000 !important;
    }
</style>
